# Gap Analysis（Phase 0 定稿）

> 状态：DONE  
> 更新时间：2026-02-11 04:25 (GMT+8)

## 1. 核心结论

zclash 当前的核心差距并非“完全缺功能”，而是：
1) **契约一致性不足**（CLI/API/TUI 语义与输出规则未完全统一）
2) **可量化与回归能力刚建立**（benchmark/metrics 已有框架，需持续实测回填）
3) **生态迁移体系尚未闭环**（兼容层、迁移工具、文档样例仍在后序阶段）

---

## 2. 差距分级（最终）

## P0（必须优先补齐）
1. CLI 命令模型与错误输出规范统一（含 `--json` 契约）  
2. API v1 资源模型与错误码体系锁定（OpenAPI 对齐）  
3. benchmark + metrics 的回归门禁落地（baseline/target 自动校验）  
4. 稳定性机制基础闭环（故障恢复路径与回滚策略）

## P1（增强项）
1. TUI 信息架构与快捷键一致性提升（首屏可读/低学习成本）  
2. 规则边界场景覆盖与诊断可视化增强  
3. 协议能力扩展与边界稳定性提升（先稳后扩）

## P2（可延后项）
1. mihomo/clash 兼容层全面化  
2. 配置迁移工具（lint + autofix）成熟化  
3. 面向生态的样例库与适配文档体系

---

## 3. 分级项到 ROADMAP 的逐项追溯映射（显式）

| 分级项 | 对应 ROADMAP Phase | ROADMAP 任务锚点 |
|---|---|---|
| P0-CLI 命令模型与错误输出规范统一 | Phase 1 | 命令模型统一、核心命令、`--json`、错误输出统一 |
| P0-API v1 资源模型与错误码体系锁定 | Phase 2 | 资源模型定义、错误码结构、OpenAPI 自动校验 |
| P0-benchmark+metrics 回归门禁 | Phase 4 | 热路径 profiling、性能回归、指标门禁 |
| P0-稳定性基础闭环（恢复/回滚） | Phase 4 | 热重载回滚、故障注入、24h/72h 长稳 |
| P1-TUI 信息架构与快捷键一致性 | Phase 3 | 信息架构重排、全局快捷键统一 |
| P1-规则边界覆盖与诊断增强 | Phase 3/4 | 连接筛选/日志过滤、故障定位与可观测增强 |
| P1-协议能力扩展与边界稳定性 | Phase 4 | 热路径优化 + 故障注入验证 |
| P2-兼容层全面化 | Phase 5 | 兼容层任务 |
| P2-迁移工具成熟化 | Phase 5 | migrator（lint + autofix） |
| P2-生态样例与适配文档体系 | Phase 5 | 接入说明 + 样例配置库 |

## 4. 关键风险、依赖与缓解策略

| 项目 | 类型 | 内容 | 缓解策略 |
|---|---|---|---|
| 契约未锁先扩功能 | 风险 | 会导致高返工和接口漂移 | 先冻结 CLI/API 契约，再进入功能扩展 |
| 基准口径不统一 | 风险 | 优化结论不可复现 | 统一 scenarios + metrics 口径并接入回归门禁 |
| testdata 覆盖不足 | 依赖 | 无法稳定回填 baseline | 先补齐核心样例（配置/规则/压力）再扩场景 |
| 长稳验证不足 | 风险 | 线上可靠性不可预估 | 在 Phase 1 并行建立 24h/72h 稳定性检查 |
| 兼容层过早投入 | 风险 | 主线资源被分散 | 兼容任务保持 P2，待 P0/P1 稳定后推进 |

---

## 5. Phase 1 入口条件（可检查版）

仅当以下条件全部满足，才进入 Phase 1：

1. **文档基线完成**  
   - `docs/benchmark/baseline.md` 已完成并包含 必补/增强/可延后 + P0/P1/P2 标注。

2. **场景与指标可执行**  
   - `docs/benchmark/scenarios.md` 覆盖 6 类核心场景；
   - `docs/benchmark/metrics.md` 至少 5 项关键指标具备 p50/p95 + baseline/target（当前已 6 项）。

3. **任务验收规则生效**  
   - `TASKS.md` 中 P0 任务具备 Acceptance Criteria；
   - 无验收标准任务不得进入 DOING。

4. **P0 收尾状态同步**  
   - P0-1 / P0-2 / P0-3 / P0-4 状态已更新到最新。

5. **Phase 1 范围冻结**  
   - 仅推进 CLI 契约统一主线（命令模型、输出规范、错误码表达），
   - 不并发拉起非必要协议扩展任务。

---

## 6. 进入 Phase 1 的执行建议

- 先做 `docs/cli/spec.md` 的命令语义冻结与示例对齐；
- 同步定义 CLI 错误输出结构（code/message/hint）；
- 将关键 CLI 行为接入 TDD/BDD 双轨验收（核心逻辑 TDD、行为流 BDD）。
