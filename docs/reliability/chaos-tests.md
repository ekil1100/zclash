# Reliability / Chaos Tests（P4-2）

## P4-2B：24h 长稳测试计划（最小落地）

## 1) 测试输入

- 测试时长：连续 **24h**
- 配置输入：使用 `testdata/config/multi-proxy.yaml`
- 流量模型：
  - 常驻低压流量（模拟日常）
  - 每 10 分钟一次突发流量（短时高并发）
- 网络扰动（可选）：
  - DNS 抖动
  - 上游延迟波动

---

## 2) 监控指标（与 perf 字段兼容）

基础指标（沿用 perf 语义，避免冲突）：
- `rule_eval_p95_ms`
- `dns_resolve_p95_ms`
- `throughput_rps`
- `handshake_p95_ms`

长稳补充指标：
- `crash_count_24h`（24h 崩溃次数）
- `auto_recover_count_24h`（自动恢复次数）
- `max_recover_time_ms`（最大恢复耗时）

说明：
- 现有 perf 字段保持不变，新增长稳字段仅追加，不复用已有字段名。

---

## 3) 判定标准

通过（PASS）：
1. 24h 内 `crash_count_24h = 0`
2. 核心性能指标无持续性退化（连续 3 个采样窗口越阈值视为失败）
3. 若发生异常，恢复耗时 `max_recover_time_ms <= 30000`

失败（FAIL）：
1. 任意进程崩溃未恢复
2. 核心指标持续越阈值
3. 恢复耗时超过 30s 或恢复后功能不完整

---

## 4) 中断恢复策略

- 进程异常退出：
  1) 立即拉起（自动重启）
  2) 记录恢复起止时间
  3) 记录恢复后首个健康检查结果

- 外部中断（机器重启/网络断连）：
  1) 标记中断区间
  2) 恢复后继续计时并附注“外部中断”标签
  3) 最终报告区分“系统问题”与“环境问题”

---

## 5) 失败归档字段（最小）

当 FAIL 时，归档记录需至少包含：
- `run_id`
- `timestamp`
- `phase`（`24h-soak`）
- `status`（`PASS|FAIL`）
- `failed_fields[]`（失败字段名）
- `recover_actions[]`（已执行恢复动作）
- `note`

建议输出到：`docs/perf/reports/history/` 对应 run 文件，字段以追加方式扩展。

---

## 6) 故障注入用例清单（首批 3 项）

### Case-1: DNS 上游超时注入
- 触发方式：将 DNS 上游临时切为不可达地址（或注入高延迟）持续 2 分钟
- 观测点：`dns_resolve_p95_ms`、错误日志率、自动恢复计数
- 恢复判定：恢复后 5 分钟内 DNS 指标回落到阈值内，且无持续错误
- DoD：
  - 能稳定复现超时告警
  - 恢复后指标回归并记录恢复动作
- 预计时长：30 分钟

### Case-2: 代理节点批量不可用注入
- 触发方式：将当前代理组前 50% 节点置为不可用（连接拒绝/黑洞）
- 观测点：连接失败率、切换后可用节点命中、`throughput_rps`
- 恢复判定：系统自动切换到可用节点，吞吐恢复到基线下限以上
- DoD：
  - 失败切换路径可见（日志/状态）
  - 恢复后吞吐不低于阈值下限
- 预计时长：40 分钟

### Case-3: 进程异常退出注入
- 触发方式：模拟主进程异常退出一次（kill 信号）
- 观测点：`crash_count_24h`、`auto_recover_count_24h`、`max_recover_time_ms`
- 恢复判定：自动拉起成功，恢复耗时 <= 30s，首个健康检查通过
- DoD：
  - 异常退出可被检测并触发自动恢复
  - 恢复时间与健康检查结果被完整归档
- 预计时长：20 分钟

### 首轮执行步骤模板（适用于 Case-1/2/3）

1) 触发（Trigger）
- 记录 `case_id`、触发时间、触发参数
- 执行对应注入动作（DNS/节点不可用/进程退出）

2) 观测（Observe）
- 记录核心指标变化：`rule_eval_p95_ms` / `dns_resolve_p95_ms` / `throughput_rps` / `handshake_p95_ms`
- 记录事件字段：错误日志、告警、恢复动作触发时间

3) 恢复（Recover）
- 执行恢复动作（恢复上游、恢复节点、自动拉起确认）
- 记录恢复完成时间与首个健康检查结果

4) 判定（Judge）
- 对照 case 级恢复判定与阈值规则，给出 PASS/FAIL

### 每轮输出字段（最小）
- `run_id`
- `case_id`
- `trigger_ts`
- `recover_ts`
- `status`（`PASS|FAIL`）
- `failed_fields[]`
- `recover_actions[]`
- `duration_ms`
- `note`

### PASS/FAIL 判定（首轮）
- PASS：触发成功 + 观测到预期异常 + 在 SLA 内恢复 + 健康检查通过
- FAIL：任一环节缺失，或恢复超时，或恢复后健康检查失败

---

## 8) 热重载回滚验证准备（依赖首轮执行结果）

### 8.1 回滚触发条件
满足任一条件即触发回滚：
1) 热重载后核心指标连续 3 个采样窗口越阈值
2) 热重载后健康检查连续失败（默认 3 次）
3) 热重载引发关键功能不可用（代理切换/连接转发失败）

### 8.2 观测点
- 重载事件：开始时间、完成时间、返回状态
- 指标观测：`rule_eval_p95_ms` / `dns_resolve_p95_ms` / `throughput_rps` / `handshake_p95_ms`
- 恢复链路：回滚开始/结束时间、回滚后首个健康检查结果

### 8.3 成功判定
- PASS：回滚触发后在 30s 内恢复到可服务状态，且关键指标回到阈值范围
- FAIL：回滚超时、回滚后健康检查失败，或指标持续越阈值

### 8.4 依赖关系（与故障注入首轮结果）
- 输入依赖：`docs/perf/reports/history/*chaos-round*.json`
- 要求：从首轮结果中复用 `failed_fields` 与 `recover_actions` 作为回滚触发样本依据

---

## 7) 72h 长稳测试计划（最小落地）

### 7.1 测试输入（与 24h 口径一致）
- 测试时长：连续 **72h**
- 配置输入：使用 `testdata/config/multi-proxy.yaml`
- 流量模型：常驻低压 + 每 10 分钟突发流量（同 24h 计划）
- 扰动策略：允许低频扰动（DNS 抖动/上游延迟波动），口径与 24h 一致

### 7.2 采样频率
- 核心性能指标：每 **5 分钟**采样一次
- 进程健康与恢复事件：实时记录（事件触发）
- 周期快照：每 **1 小时**写入一次阶段汇总

### 7.3 判定标准
通过（PASS）：
1. 72h 内无“未恢复崩溃”事件
2. 核心指标未出现持续性退化（连续 3 个窗口越阈值即失败）
3. 任一恢复事件 `max_recover_time_ms <= 30000`

失败（FAIL）：
1. 出现未恢复崩溃
2. 核心指标持续越阈值
3. 恢复耗时 > 30s 或恢复后健康检查失败

### 7.4 中断恢复策略（与 24h 一致）
- 进程异常退出：自动拉起 -> 记录恢复起止 -> 记录恢复后健康检查
- 外部中断：标记中断区间 -> 恢复后继续计时 -> 最终报告区分系统/环境问题

### 7.5 失败归档字段（与 24h 一致）
- `run_id`
- `timestamp`
- `phase`（`72h-soak`）
- `status`（`PASS|FAIL`）
- `failed_fields[]`
- `recover_actions[]`
- `note`

### 7.6 72h 执行前检查清单（基于 24h 结果）

执行前检查：
- 资源检查：
  - 磁盘剩余空间满足归档增长（建议 > 2GB）
  - 进程与系统监控可用（CPU/内存/网络）
- 阈值检查：
  - 沿用 24h 通过批次阈值（README 第4节）
  - 若需调整阈值，需先记录原因与回收条件
- 归档路径检查：
  - `docs/perf/reports/history/` 可写
  - 命名模式：`*soak-72h-*.json`

启动条件（Start Gate）：
1) 最近一次 24h 执行结果为 PASS（已归档）
2) 回滚验证已完成且无未恢复失败
3) 检查脚本入口可执行（`run-soak.sh` / `prune-history.sh`）

中止条件（Abort Gate）：
1) 连续 3 个采样窗口核心指标越阈值
2) 发生未恢复崩溃或恢复超时（>30s）
3) 归档写入失败或监控数据缺失超过 15 分钟
