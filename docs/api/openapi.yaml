openapi: 3.0.3
info:
  title: zclash API
  version: 0.1.0-draft
  description: |
    Draft API v1 resource model for zclash.
    Phase P2-1 focuses on runtime/profiles/proxies core resources.
servers:
  - url: http://127.0.0.1:9090
    description: local controller

tags:
  - name: runtime
  - name: profiles
  - name: proxies

x-api-boundary:
  rest:
    purpose: Resource snapshot and command-style state changes
    endpoints:
      - /v1/runtime
      - /v1/profiles
      - /v1/profiles/active
      - /v1/profiles/import
      - /v1/proxies
      - /v1/proxies/select
      - /v1/connections
      - /v1/rules
      - /v1/metrics
    guarantees:
      - REST responses are request-scoped snapshots
      - REST operations must be idempotent where HTTP verb implies idempotency
  websocket:
    purpose: Streaming runtime events and incremental updates
    endpoint: /v1/events
    eventTypes:
      - runtime.state_changed
      - proxy.selection_changed
      - connection.opened
      - connection.closed
      - metrics.tick
    guarantees:
      - WS does not replace REST bootstrap; clients should first GET baseline via REST
      - Event payloads should be additive-compatible within v1

x-versioning:
  currentMajor: v1
  compatibility:
    - No breaking field removal/rename within v1
    - New fields must be optional or have safe defaults
    - Error envelope stays stable: ok=false + error.code/message/hint
  breakingChangePolicy:
    - Breaking changes require new major path (e.g. /v2)
    - Provide migration notes before deprecating v1 behavior
  deprecation:
    - Deprecated fields/endpoints must include sunset note and transition path

x-error-code-dictionary:
  source: ./error-codes.md
  groups:
    config:
      - CONFIG_NOT_FOUND
      - CONFIG_PARSE_FAILED
      - CONFIG_SWITCH_FAILED
    network:
      - NETWORK_DNS_FAILED
      - NETWORK_CONNECT_TIMEOUT
      - NETWORK_PORT_IN_USE
    provider:
      - PROVIDER_UNREACHABLE
      - PROVIDER_AUTH_FAILED
      - PROVIDER_RESPONSE_INVALID
    validation:
      - VALIDATION_RULE_INVALID
      - VALIDATION_PROXY_INVALID
      - VALIDATION_PORT_CONFLICT
    auth:
      - AUTH_PERMISSION_DENIED
      - AUTH_TOKEN_MISSING
      - AUTH_TOKEN_INVALID
    resource_path:
      - PROFILE_LIST_FAILED
      - PROFILE_SUBCOMMAND_MISSING
      - PROFILE_SUBCOMMAND_UNKNOWN
      - PROFILE_NAME_REQUIRED
      - PROFILE_NOT_FOUND
      - PROFILE_USE_FAILED
      - PROFILE_SOURCE_REQUIRED
      - PROFILE_IMPORT_FAILED
      - PROFILE_VALIDATE_FAILED
      - PROXY_CONFIG_LOAD_FAILED
      - PROXY_GROUP_NOT_FOUND
      - PROXY_NOT_FOUND
      - PROXY_SELECT_GROUP_MISSING
      - PROXY_SELECT_FAILED
      - PROXY_SUBCOMMAND_UNKNOWN
      - DIAG_DOCTOR_FAILED
      - DIAG_SUBCOMMAND_UNKNOWN

paths:
  /v1/runtime:
    get:
      tags: [runtime]
      summary: Get runtime status
      operationId: getRuntime
      responses:
        '200':
          description: Runtime status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuntimeStatusResponse'

  /v1/profiles:
    get:
      tags: [profiles]
      summary: List available profiles
      operationId: listProfiles
      responses:
        '200':
          description: Profile list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileListResponse'

  /v1/profiles/active:
    get:
      tags: [profiles]
      summary: Get active profile
      operationId: getActiveProfile
      responses:
        '200':
          description: Active profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileActiveResponse'

    put:
      tags: [profiles]
      summary: Switch active profile
      operationId: setActiveProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileActivateRequest'
      responses:
        '200':
          description: Profile switched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileActiveResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/profiles/import:
    post:
      tags: [profiles]
      summary: Import profile from URL or local path
      operationId: importProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileImportRequest'
      responses:
        '200':
          description: Import result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileImportResponse'
        '400':
          description: Invalid request or source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/proxies:
    get:
      tags: [proxies]
      summary: List proxy groups and nodes
      operationId: listProxies
      responses:
        '200':
          description: Proxy graph
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProxyListResponse'

  /v1/proxies/select:
    post:
      tags: [proxies]
      summary: Select a proxy for a group
      operationId: selectProxy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProxySelectRequest'
      responses:
        '200':
          description: Selection result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProxySelectResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Group or proxy not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /v1/connections:
    get:
      tags: [runtime]
      summary: List active connections
      operationId: listConnections
      responses:
        '200':
          description: Active connection list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionListResponse'

  /v1/rules:
    get:
      tags: [runtime]
      summary: List loaded rules
      operationId: listRules
      responses:
        '200':
          description: Rules list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleListResponse'

  /v1/metrics:
    get:
      tags: [runtime]
      summary: Get runtime metrics snapshot
      operationId: getMetrics
      responses:
        '200':
          description: Metrics snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /v1/events:
    get:
      tags: [runtime]
      summary: WebSocket event stream endpoint (upgrade)
      description: |
        Upgrade to WebSocket and subscribe to incremental runtime events.
        Clients should bootstrap via REST first, then consume WS deltas.
      responses:
        '101':
          description: Switching Protocols (WebSocket upgrade)
        '400':
          description: Invalid upgrade request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    RuntimeStatusResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            state:
              type: string
              enum: [running, stopped]
            pid:
              type: integer
              nullable: true
            mode:
              type: string
              example: rule
            startedAt:
              type: string
              format: date-time
              nullable: true

    ProfileListResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            profiles:
              type: array
              items:
                type: string
            active:
              type: string
              nullable: true

    ProfileActiveResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            profile:
              type: string
            state:
              type: string
              enum: [active]

    ProfileActivateRequest:
      type: object
      required: [profile]
      properties:
        profile:
          type: string

    ProfileImportRequest:
      type: object
      required: [source]
      properties:
        source:
          type: string
          description: URL or local path
        name:
          type: string
          nullable: true

    ProfileImportResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            action:
              type: string
              enum: [profile_import]
            profile:
              type: string
            source:
              type: string

    ProxyListResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            groups:
              type: array
              items:
                $ref: '#/components/schemas/ProxyGroup'
            stats:
              type: object
              properties:
                group_count:
                  type: integer
                proxy_count:
                  type: integer

    ProxyGroup:
      type: object
      properties:
        name:
          type: string
        type:
          type: string
        proxies:
          type: array
          items:
            $ref: '#/components/schemas/ProxyNode'

    ProxyNode:
      type: object
      properties:
        name:
          type: string
        type:
          type: string

    ProxySelectRequest:
      type: object
      required: [group]
      properties:
        group:
          type: string
        proxy:
          type: string
          nullable: true

    ProxySelectResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            action:
              type: string
              enum: [proxy_select]
            group:
              type: string
            proxy:
              type: string
              nullable: true
            choices:
              type: array
              items:
                type: string
              nullable: true
            state:
              type: string
              nullable: true

    ConnectionListResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            connections:
              type: array
              items:
                $ref: '#/components/schemas/ConnectionEntry'

    ConnectionEntry:
      type: object
      properties:
        id:
          type: string
        network:
          type: string
          example: tcp
        target:
          type: string
          example: api.openai.com:443
        inbound:
          type: string
          example: mixed
        outbound:
          type: string
          example: PROXY
        startAt:
          type: string
          format: date-time

    RuleListResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            rules:
              type: array
              items:
                $ref: '#/components/schemas/RuleEntry'

    RuleEntry:
      type: object
      properties:
        type:
          type: string
          example: DOMAIN-SUFFIX
        payload:
          type: string
          example: google.com
        target:
          type: string
          example: PROXY

    MetricsResponse:
      type: object
      properties:
        ok:
          type: boolean
        data:
          type: object
          properties:
            runtime:
              type: object
              properties:
                uptime_sec:
                  type: integer
                goroutines:
                  type: integer
            traffic:
              type: object
              properties:
                upload_bytes:
                  type: integer
                download_bytes:
                  type: integer
            latency:
              type: object
              properties:
                dns_p50_ms:
                  type: number
                dns_p95_ms:
                  type: number

    ErrorResponse:
      type: object
      properties:
        ok:
          type: boolean
          enum: [false]
        error:
          type: object
          required: [code, message, hint]
          properties:
            code:
              type: string
              description: Stable machine-readable code. See x-error-code-dictionary and docs/api/error-codes.md.
              enum:
                - CONFIG_NOT_FOUND
                - CONFIG_PARSE_FAILED
                - CONFIG_SWITCH_FAILED
                - NETWORK_DNS_FAILED
                - NETWORK_CONNECT_TIMEOUT
                - NETWORK_PORT_IN_USE
                - PROVIDER_UNREACHABLE
                - PROVIDER_AUTH_FAILED
                - PROVIDER_RESPONSE_INVALID
                - VALIDATION_RULE_INVALID
                - VALIDATION_PROXY_INVALID
                - VALIDATION_PORT_CONFLICT
                - AUTH_PERMISSION_DENIED
                - AUTH_TOKEN_MISSING
                - AUTH_TOKEN_INVALID
                - PROFILE_LIST_FAILED
                - PROFILE_SUBCOMMAND_MISSING
                - PROFILE_SUBCOMMAND_UNKNOWN
                - PROFILE_NAME_REQUIRED
                - PROFILE_NOT_FOUND
                - PROFILE_USE_FAILED
                - PROFILE_SOURCE_REQUIRED
                - PROFILE_IMPORT_FAILED
                - PROFILE_VALIDATE_FAILED
                - PROXY_CONFIG_LOAD_FAILED
                - PROXY_GROUP_NOT_FOUND
                - PROXY_NOT_FOUND
                - PROXY_SELECT_GROUP_MISSING
                - PROXY_SELECT_FAILED
                - PROXY_SUBCOMMAND_UNKNOWN
                - DIAG_DOCTOR_FAILED
                - DIAG_SUBCOMMAND_UNKNOWN
            message:
              type: string
            hint:
              type: string
