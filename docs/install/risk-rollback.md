# 安装链路风险清单与回滚策略（P6-2B 草案）

> 口径：与现有排障文档一致，统一使用“问题 -> next-step -> 回滚建议”。

## 1) 权限问题（Permission）

### 场景
- 安装脚本无执行权限
- 写入目标目录被拒绝（如 `/usr/local/bin`）

### next-step
1. 检查脚本权限：`chmod +x <script>`
2. 切换到有权限目录或使用具备权限的账号执行
3. 记录失败点到安装日志（命令 + stderr）

### 回滚建议
- 删除本次已创建的临时文件/半成品链接
- 恢复被覆盖的旧二进制（若有 `.bak`）

---

## 2) 路径问题（Path）

### 场景
- 安装目标路径不存在
- PATH 未包含安装目录，导致“安装成功但命令不可用”

### next-step
1. 创建目标目录并重试
2. 执行 `which <command>` 与 `echo $PATH` 验证路径生效
3. 明确输出“命令真实落地路径”

### 回滚建议
- 移除新建路径下的安装产物
- 回退 shell 配置中新增的 PATH 片段

---

## 3) 依赖问题（Dependency）

### 场景
- 缺失运行时依赖（shell/node/openssl 等）
- 依赖版本过低导致安装后校验失败

### next-step
1. 先执行 `verify` 子命令定位缺失依赖
2. 输出最小依赖版本与安装建议
3. 依赖补齐后重跑 install + verify

### 回滚建议
- 仅回滚本次安装变更，不回滚系统级依赖本身
- 标记“依赖缺失”状态，避免重复覆盖安装

---

## 4) 平台差异问题（Platform）

### 场景
- Darwin/Linux 路径差异
- arm64/x86_64 架构不匹配

### next-step
1. 启动前检测 `uname -s` / `uname -m`
2. 明确输出“当前平台 + 目标包”映射
3. 不匹配时 fail-fast，并给出可执行替代下载目标

### 回滚建议
- 删除错误平台产物
- 恢复到安装前版本（若已替换）

---

## 5) 通用回滚原则

1. 先停止后回滚：先停止当前异常服务/进程，再替换文件
2. 原地可恢复：默认保留 `.bak` 到校验通过后再清理
3. 回滚后必须执行 `verify`，确认可用性恢复

---

## 6) 最小故障回执模板（与现有口径一致）

- `code`：错误分类（如 `INSTALL_PERMISSION_DENIED`）
- `message`：失败描述
- `hint`：下一步可执行动作（next-step）
- `rollback`：建议的回滚动作摘要
